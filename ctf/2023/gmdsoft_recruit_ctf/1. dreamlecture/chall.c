/* This file was generated by the Hex-Rays decompiler version 8.3.0.230608.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void *init_proc();
void sub_7D0();
// char *strtok(char *s, const char *delim);
// unsigned __int64 strtoul(const char *nptr, char **endptr, int base);
// int __fastcall __cxa_finalize(void *);
// int __fastcall __libc_start_main(int (__fastcall *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end);
// __int64 __gmon_start__(void); weak
// void __noreturn abort(void);
// int puts(const char *s);
// __int64 __isoc99_scanf(const char *, ...); weak
// int printf(const char *format, ...);
// int mprotect(void *addr, size_t len, int prot);
void __fastcall __noreturn start(void (*rtld_fini)(void), int a2, int a3, int a4, int a5, int a6, int a7, int a8, int argc, char *ubp_av); // idb
void *call_weak_fn();
void *deregister_tm_clones();
void *register_tm_clones();
__int64 _do_global_dtors_aux();
__int64 setup();
bool __fastcall verify_code(unsigned int a1, int a2);
__int64 print_notifications();
__int64 print_my_tickets();
__int64 print_extend_ticket();
int __fastcall main(int argc, const char **argv, const char **envp);
void *__fastcall _libc_csu_init(unsigned int a1, __int64 a2, __int64 a3);
__int64 __fastcall _libc_csu_fini(); // weak
void term_proc();
// int __fastcall _cxa_finalize(void *);
// __int64 ITM_deregisterTMCloneTable(void); weak
// __int64 ITM_registerTMCloneTable(void); weak

//-------------------------------------------------------------------------
// Data declarations

char byte_E58[8] = { '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0' }; // weak
__int64 (__fastcall *_frame_dummy_init_array_entry)() = &frame_dummy; // weak
__int64 (__fastcall *_do_global_dtors_aux_fini_array_entry)() = &_do_global_dtors_aux; // weak
void *_dso_handle = &_dso_handle; // weak
_DWORD references[6] = { -1425071751, 1356867666, 1679302827, 1379004578, -44064751, 0 }; // weak
_UNKNOWN secret_function; // weak
char _bss_start; // weak
_UNKNOWN end; // weak
// extern _UNKNOWN _gmon_start__; weak


//----- (00000000000007B0) ----------------------------------------------------
void *init_proc()
{
  return call_weak_fn();
}

//----- (00000000000007D0) ----------------------------------------------------
void sub_7D0()
{
  JUMPOUT(0LL);
}
// 7E0: control flows out of bounds to 0

//----- (00000000000008A0) ----------------------------------------------------
void __fastcall __noreturn start(
        void (*rtld_fini)(void),
        int a2,
        int a3,
        int a4,
        int a5,
        int a6,
        int a7,
        int a8,
        int argc,
        char *ubp_av)
{
  __libc_start_main(
    (int (__fastcall *)(int, char **, char **))main,
    argc,
    &ubp_av,
    (void (*)(void))_libc_csu_init,
    (void (*)(void))_libc_csu_fini,
    rtld_fini,
    &argc);
  abort();
}
// CF8: using guessed type __int64 __fastcall _libc_csu_fini();

//----- (00000000000008D8) ----------------------------------------------------
void *call_weak_fn()
{
  void *result; // x0

  result = &_gmon_start__;
  if ( &_gmon_start__ )
    return (void *)__gmon_start__();
  return result;
}
// 840: using guessed type __int64 __gmon_start__(void);

//----- (00000000000008F0) ----------------------------------------------------
void *deregister_tm_clones()
{
  return &end;
}
// 14D28: using guessed type __int64 ITM_deregisterTMCloneTable(void);

//----- (0000000000000920) ----------------------------------------------------
void *register_tm_clones()
{
  return &end;
}
// 14D38: using guessed type __int64 ITM_registerTMCloneTable(void);

//----- (0000000000000960) ----------------------------------------------------
__int64 _do_global_dtors_aux()
{
  __int64 result; // x0

  result = (unsigned __int8)_bss_start;
  if ( !_bss_start )
  {
    if ( &_cxa_finalize )
      __cxa_finalize(_dso_handle);
    deregister_tm_clones();
    result = 1LL;
    _bss_start = 1;
  }
  return result;
}
// 12008: using guessed type void *_dso_handle;
// 14C75: using guessed type char _bss_start;

//----- (00000000000009AC) ----------------------------------------------------
__int64 setup()
{
  return mprotect((void *)((unsigned __int64)&secret_function & 0xFFFFFFFFFFFFF000LL), 0x2C4DuLL, 7);
}

//----- (00000000000009D8) ----------------------------------------------------
bool __fastcall verify_code(unsigned int a1, int a2)
{
  return (unsigned int)((__int64 (__fastcall *)(_QWORD))secret_function)(a1) == a2;
}

//----- (0000000000000A20) ----------------------------------------------------
__int64 print_notifications()
{
  puts("===[ DreamLecture / Notifications ]=============================================================");
  puts("Your ticket #4 (1 year) will expire in 2 days and 7 hours.");
  puts("Please enter the code to extend your ticket.");
  puts("================================================================================================");
  return puts(byte_E58);
}

//----- (0000000000000A70) ----------------------------------------------------
__int64 print_my_tickets()
{
  puts("===[ DreamLecture / Settings / My Tickets ]=====================================================");
  puts("Ticket #1 (7 days trial) : Z7AANT-JL32FN-FLH1DR-QR3VMX-GP4Q3C : expired on 2022-11-02 12:00:00");
  puts("Ticket #2 (3 months)     : 3Q4Q3C-7AANTJ-L32FNF-LH1DRQ-R3VMXG : expired on 2022-02-02 12:00:00");
  puts("Ticket #3 (3 months)     : ZYM2NN-JU838R-9XG3TN-RVTGUK-G44HY7 : expired on 2022-05-02 12:00:00");
  puts("Ticket #4 (1 year)       : PY433Y-RGGF58-H57H7Q-HK96DX-GP6P22 : expires on 2023-05-02 12:00:00");
  puts("================================================================================================");
  return puts(byte_E58);
}

//----- (0000000000000AD8) ----------------------------------------------------
__int64 print_extend_ticket()
{
  puts("===[ DreamLecture / Settings / Extend Ticket ]==================================================");
  puts("The ticket code consists of 5 groups of 6 characters of [0-9A-Z].");
  puts("Sample Code: YA6HSV-22E6E2-78GKKJ-RG8Y76-4MAJ3D");
  puts("================================================================================================");
  return puts(byte_E58);
}

//----- (0000000000000B28) ----------------------------------------------------
int __fastcall main(int argc, const char **argv, const char **envp)
{
  int i; // [xsp+10h] [xbp+10h]
  unsigned int v5; // [xsp+14h] [xbp+14h]
  const char *nptr; // [xsp+18h] [xbp+18h]
  char s[40]; // [xsp+20h] [xbp+20h] BYREF

  setup();
  print_notifications();
  print_my_tickets();
  print_extend_ticket();
  printf("> ");
  __isoc99_scanf("%36s", s);
  nptr = strtok(s, "-");
  for ( i = 0; i <= 4; ++i )
  {
    if ( !nptr )
    {
      puts("The code is invalid. Please try again.");
      return 0;
    }
    v5 = strtoul(nptr, 0LL, 36);
    if ( !verify_code(v5, references[i]) )
    {
      puts("Invalid code.");
      return 0;
    }
    nptr = strtok(0LL, "-");
  }
  puts("Ticket #5 (10 years) has been added to your account.");
  puts("Happy hacking with DreamLecture!");
  return 0;
}
// 870: using guessed type __int64 __isoc99_scanf(const char *, ...);
// 12010: using guessed type _DWORD references[6];

//----- (0000000000000C78) ----------------------------------------------------
void *__fastcall _libc_csu_init(unsigned int a1, __int64 a2, __int64 a3)
{
  void *result; // x0
  __int64 v7; // x19
  __int64 (__fastcall *v8)(_QWORD, __int64, __int64); // x3

  result = init_proc();
  if ( &_do_global_dtors_aux_fini_array_entry - &_frame_dummy_init_array_entry )
  {
    v7 = 0LL;
    do
    {
      v8 = (__int64 (__fastcall *)(_QWORD, __int64, __int64))*(&_frame_dummy_init_array_entry + v7++);
      result = (void *)v8(a1, a2, a3);
    }
    while ( &_do_global_dtors_aux_fini_array_entry - &_frame_dummy_init_array_entry != v7 );
  }
  return result;
}
// 11D38: using guessed type __int64 (__fastcall *_frame_dummy_init_array_entry)();
// 11D40: using guessed type __int64 (__fastcall *_do_global_dtors_aux_fini_array_entry)();

//----- (0000000000000CFC) ----------------------------------------------------
void term_proc()
{
  ;
}

// nfuncs=39 queued=15 decompiled=15 lumina nreq=0 worse=0 better=0
// ALL OK, 15 function(s) have been successfully decompiled
